<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Leaflet – OSM + CSV & Heatmap & Shapefiles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

  <!-- Styles -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .reportCluster { background: rgba(255,255,255,0.8); padding: 8px; border-radius: 4px; box-shadow: 0 0 8px rgba(0,0,0,0.2); width: 220px; font-family: sans-serif; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([43.7, -79.4], 10);

    // Base layers
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' });
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri', maxZoom: 19 });
    osm.addTo(map);

    // Layer control
    const layersControl = L.control.layers({ 'OSM': osm, 'Satellite': satellite }, {}, { collapsed: false }).addTo(map);

    // Heatmap & clustering
    let heatPoints = [], heatLayer;
    const heatThreshold = 13;
    // const heatGradient = {
    //   0.1: 'rgba(0,   0,   255, 0.2)',
    //   0.3: 'rgba(0,   255, 0,   0.3)',
    //   0.5: 'rgba(255, 255, 0,   0.4)',
    //   0.7: 'rgba(255, 165, 0,   0.5)', 
    //   1.0: 'rgba(255, 0,   0,   0.6)' 
    // };
    const heatGradient = {
      0.1: 'blue',   // low intensity
      0.2: 'lime',   // moderate-low intensity
      0.3: 'yellow', // medium intensity
      0.4: 'orange', // moderate-high intensity
      0.7: 'red'     // highest intensity
    };
    const markers = L.markerClusterGroup();
    Papa.parse('/data/npop_points.csv', {
      header: true, download: true,
      complete: ({ data }) => {
        data.forEach(r => {
          const lat = +r.y, lon = +r.x;
          if (!isNaN(lat) && !isNaN(lon)) {
            // create the marker and bind its popup
            const mk = L.marker([lat, lon]).bindPopup(
              `<strong>${r.name || 'n/a'}</strong><br>${r.address || 'n/a'}`
            );

            // zoom-in-on-click
            mk.on('click', e => {
              // you can adjust the "18" below to control how close you zoom in
              map.setView(e.latlng, 18);
            });

            markers.addLayer(mk);
            heatPoints.push([lat, lon, 1]);
          }
        });
        map.addLayer(markers);
        updateHeat();
      }
    });
    function updateHeat() {
      if (heatLayer) map.removeLayer(heatLayer);
      heatLayer = L.heatLayer(heatPoints, { radius: 50, blur: 30, minOpacity: 0.3, gradient: heatGradient});
      if (map.getZoom() <= heatThreshold) map.addLayer(heatLayer);
    }
    map.on('zoomend', () => {
      if (map.getZoom() > heatThreshold) map.removeLayer(heatLayer);
      else if (heatLayer) map.addLayer(heatLayer);
    });

    // --- Highlight Functions for FSA Layers ---
    function highlightFeatureStyle(layer, baseStyle) {
      layer.setStyle({
        weight:      (baseStyle.weight || 2) + 3,         // increased border weight
        color:       '#02c002',                               // grey border on hover
        fillOpacity: (baseStyle.opacity || 0.3) + 0.2      // more opaque fill
      });
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) layer.bringToFront();
    }

    // Report controls
    const fsaControl = L.control({ position: 'topright' });
    fsaControl.onAdd = () => L.DomUtil.create('div', 'reportCluster').appendChild(document.createTextNode('Hover over an area to see detailed FSA info.')).parentNode;
    fsaControl.addTo(map);

    const bldgControl = L.control({ position: 'topright' });
    bldgControl.onAdd = () => L.DomUtil.create('div', 'reportCluster').appendChild(document.createTextNode('Click on building')).parentNode;
    bldgControl.addTo(map);

    const fsaConfigs = [
  { zip: '/data/ontario_fsa.zip', label: 'Ontario FSA', style: { color: '#888', weight: 2, opacity: 0.15 } },
  { zip: '/data/quebec_fsa.zip',   label: 'Quebec FSA',   style: { color: '#888', weight: 2, opacity: 0.15 } }
];

fsaConfigs.forEach(({ zip, label, style }) => {
  shp(zip)
    .then(geojson => {
      const layer = L.geoJSON(geojson, {
        style: style,
        onEachFeature: (feat, lyr) => {
          // <-- CHANGED: add hover highlight and reset
          lyr.on('mouseover', e => {
            highlightFeatureStyle(e.target, style);    // bold & grey highlight
            const p = feat.properties;
            fsaControl.getContainer().innerHTML =
              `<strong>${p.PRNAME||'n/a'} – <i>${p.CFSAUID||'n/a'}</i></strong><br>` +
              `DGUID: ${p.DGUID||'n/a'}<br>` +
              `Land area: ${p.LANDAREA||'—'}<br>` +
              `NPOP Count: <strong>${p.npop_count||'n/a'}</strong>`;
          });
          lyr.on('mouseout', e => {
            lyr.setStyle(style);                        // reset to original style
            fsaControl.getContainer().innerHTML =
              'Hover over an area to see detailed FSA info.';
          });
        }
      }).addTo(map);
      layersControl.addOverlay(layer, label);
    })
    .catch(e => console.error(`${label} load error`, e));
});


    // Building JSON layer
    fetch('./data/npop_buildings.json')
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(js => {
        const bldgLayer = L.geoJSON(js, {
          style: { color: '#e555f6', weight: 2, opacity: 0.5 },
          onEachFeature: (feat, lyr) => {
            lyr.on('click', () => {
              const p = feat.properties;
              bldgControl.getContainer().innerHTML = `<strong>${p.name||'n/a'}</strong><br>${p.entityId||'n/a'}<br>${p.description||'n/a'}`;
            });
          }
        }).addTo(map);
        layersControl.addOverlay(bldgLayer, 'Buildings');
      })
      .catch(e => console.error('Buildings load error', e));

  </script>
</body>
</html>
