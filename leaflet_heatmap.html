<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Leaflet – OSM + CSV & Heatmap & Shapefiles + Search + Report + Filter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

  <!-- Styles for map, controls, and UI elements -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css"/>
  <style>
    html,
    body,
    #map {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    .reportCluster {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 70%, rgba(230, 245, 255, 0.85) 100%);
        padding: 10px 14px;
        border-radius: 8px;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 12px;
        color: #222;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.18), 0 1.5px 4px rgba(0, 120, 255, 0.07);
        border: 1px solid #e0e7ef;
        position: relative;
        z-index: 1000;
        transition: box-shadow 0.2s, border 0.2s;
    }

    .reportCluster:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.22), 0 2px 8px rgba(0, 120, 255, 0.10);
        border: 1.5px solid #b3d4fc;
    }

    /* Legend container */

    .info.legend {
        padding: 20px 25px;
        font: 12px/14px Arial, sans-serif;
        background: white;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    /* colored squares */

    .info.legend i {
        width: 14px;
        height: 14px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
        border-radius: 50%;
        z-index: 1000;  
    }

    #reportTitle {
        position: absolute;
        top: 10px;
        left: 0;
        right: 0;
        text-align: center;
        z-index: 1000;
        font-size: 24px;
        font-weight: bold;
        color: black;
        text-shadow: -2px 0 white, 0 2px white, 2px 0 white, 0 -2px white;
    }
    #searchContainer {
     display: flex;
     flex-direction: column;
     gap: 4px;
    }

    #searchContainer input[type="text"] {
     padding: 5px;
     border: 1px solid #ccc;
     border-radius: 4px;
    }

    #searchContainer label {
     font-size: 12px;
    }

    #controlsContainer {
        position: absolute;
        top: 12px;
        left: 50px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.8);
        width: 260px;
        font-family: sans-serif;
        font-size: 12px;
        color: #333;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px;
        border-radius: 6px;
    }

    /* constrain popup width */
.leaflet-popup-content-wrapper .popup-group {
  max-width: 260px;
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 13px;
}

.leaflet-popup-content-wrapper .device-entry {
  margin-bottom: 8px;
}

.leaflet-popup-content-wrapper .device-entry h4 {
  margin: 0 0 4px;
  font-size: 14px;
  color: #007bff;
}

.leaflet-popup-content-wrapper .device-entry p {
  margin: 2px 0;
  line-height: 1.3;
}

.leaflet-popup-content-wrapper hr {
  border: none;
  border-top: 1px solid #ddd;
  margin: 6px 0;
}

.device-dot {
  width: 10px; height: 10px;
  background: rgba(255, 165, 0, 0.8);
  border: 1px solid white;
  border-radius: 50%;
}

    #filterContainer {
        display: flex;
        align-items: center;
        padding: 4px;
        border-radius: 4px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
        width: 100%;
        gap: 4px;
    }

    #filterInput {
        flex: 1;
        padding: 4px;
        font-size: 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    #clearBtn {
        background: #e0e0e0;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 14px;
    }

    #clearBtn:hover {
        background: #ccc;
    }

    #weekSelector {
        padding: 4px;
        font-size: 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="reportTitle">Npop - DeviceCount & Distribution Report</div>
  <div id="controlsContainer">
    <div id="searchContainer">
      <input type="text" id="searchInput" placeholder="Search device..." list="suggestions" />
      <datalist id="suggestions"></datalist>
      <label><input type="radio" name="searchMode" value="Device_Entity_ID" checked /> Entity ID</label>
      <label><input type="radio" name="searchMode" value="Address" /> Address</label>
    </div>    
    <div id="reportBox1" class="reportCluster">>
      Showing total npop count by city: <strong><span id="npopCount">0</span></strong>
    </div>
    <div id="reportBox2" class="reportCluster">>
      Showing total device count by city: <strong><span id="npopCount">0</span></strong>
    </div>

    <select id="weekSelector"></select>
    <div id="filterContainer">
      <input id="filterInput" list="filterList" placeholder="Filter by name..." />
      <button id="clearBtn" title="Clear filter">×</button>
    </div>
    <datalist id="filterList"></datalist>
  </div>
  <div id="map"></div>

  <!-- External JS libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/overlapping-marker-spiderfier-leaflet/oms.min.js"></script>


  <!-- XLSX library for reading Excel files -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- <script>
    // Initialize variables
    let geojsonData = null;
    let currentWeek = null;
    const usageByPostal = {};
    const reportBox1 = document.getElementById('reportBox1');
    const reportBox2 = document.getElementById('reportBox2');

  // create a map and set its view to Toronto
  const map=L.map('map').setView([43.7, -79.4], 10);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' });
        const satellite = L.tileLayer(
          'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          { attribution: '© Esri', maxZoom: 19 }
        );
        osm.addTo(map);
        L.control.layers({ 'OSM': osm, 'Satellite': satellite }, {}, { collapsed: false }).addTo(map);

// create a legend control for the device usage

const legend = L.control({ position: 'bottomright' });

legend.onAdd = function(map) {
  const div = L.DomUtil.create('div', 'info legend');
  const thresholds = [0, 15, 30, 45, 60, 75, 90];
  const labels = [
    'No Usage - <b>0%</b>',
    'Very Low - <b>&lt;15%</b>',
    'Low - <b>&lt;30%</b>',
    'Moderate - <b>&lt;45%</b>',
    'Elevated - <b>&lt;60%</b>',
    'High - <b>&lt;75%</b>',
    'Critical - <b>&lt;90%</b>',
  ];

  div.innerHTML += '<div style="font-weight:bold; margin-bottom:6px;">Usage Legend</div>';
  
  for (let i = 0; i < thresholds.length; i++) {
    div.innerHTML += `
      <div style="display: flex; align-items: center; margin-bottom: 4px;">
        <i style="
          background: ${getColor(thresholds[i])};
          width: 16px;
          height: 16px;
          border-radius: 50%;
          margin-right: 8px;
          border: 1px solid #bbb;
          display: inline-block;
        "></i>
        <span>${labels[i]}</span>
      </div>
    `;
  }
  return div;
};
legend.addTo(map);


// add a search control
const searchInput = document.getElementById('searchInput');
const suggestions = document.getElementById('suggestions');
const modeRadios = document.querySelectorAll('input[name="searchMode"]');
let deviceData = []; // store your loaded rows for search

// Load data from Excel (reuse already loaded `rows`)
function populateSearch(rows) {
  deviceData = rows;

  updateSuggestions(); // initial

  searchInput.addEventListener('input', () => {
    updateSuggestions(searchInput.value);
  });

  searchInput.addEventListener('change', () => {
    const mode = getSearchMode();
    const match = deviceData.find(r =>
      (r[mode] || '').toLowerCase().includes(searchInput.value.toLowerCase())
    );
    if (match && match.Lat && match.Lon) {
      map.setView([match.Lat, match.Lon], 15);
      L.popup()
        .setLatLng([match.Lat, match.Lon])
        .setContent(`<strong>${match.Address}</strong><br>${match.Device_Entity_ID}`)
        .openOn(map);
    }
  });

  modeRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      updateSuggestions(searchInput.value); // FIX HERE
    });
  });
}
function getSearchMode() {
  return [...modeRadios].find(r => r.checked).value;
}

function updateSuggestions(term = '') {
  const mode = getSearchMode();
  const uniqueValues = [...new Set(
    deviceData
      .map(r => r[mode])
      .filter(v => v && v.toLowerCase().includes(term.toLowerCase()))
  )].slice(0, 10); // show top 10 matches

  suggestions.innerHTML = '';
  uniqueValues.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val;
    suggestions.appendChild(opt);
  });
}

const searchControl = new L.Control.Search({
  layer: window.fsaLayer,
  propertyName: 'ZIP',
  zoom: 12,
  marker: false,
  moveToLocation: function(latlng, title, map) {
    map.setView(latlng, 12);
    // add a popup to the marker
    const popup = L.popup()
      .setLatLng(latlng)
      .setContent(title)
      .openOn(map);
  }
});
// add the search control to the map
map.addControl(searchControl);
// add a filter input
const filterInput = document.getElementById('filterInput');
const filterList = document.getElementById('filterList');
const clearBtn = document.getElementById('clearBtn');
const reportBox = document.getElementById('reportBox');
const npopCount = document.getElementById('npopCount');
const deviceCount = document.getElementById('deviceCount');
const weekSelector = document.getElementById('weekSelector');
const weekList = [];

function getColor(d) {
  return d >= 90  ? '#BD0026' :
         d >= 75  ? '#E31A1C' :
         d >= 60  ? '#FC4E2A' :
         d >= 45  ? '#FD8D3C' :
         d >= 30  ? '#FEB24C' :
         d >= 15  ? '#FED976' :
                    '#FFEDA0';
}

function drawMap(week) {
    window.fsaLayer=L.geoJSON(geojsonData, {
        style: f=> ( {
            fillColor: getColor(usageByPostal[f.properties.ZIP]?.[week]||0), weight:1, color:'white', dashArray:'3', fillOpacity:0.7
        }
        ), onEachFeature: (f, l)=> l.bindPopup(`<b>ZIP:</b>$ {
            f.properties.ZIP
        }
        <br><b>Usage($ {
            week
        }
        ):</b>$ {
            usageByPostal[f.properties.ZIP]?.[week]||0
        }
        %`)
    }
    ).addTo(map);
  }
  
  // Load GeoJSON
  // fetch('data/ontario_fsa_with_npop_count.geojson').then(r=>r.json()).then(d=>{geojsonData=d;});
  fetch('data/lfsa000a21a_e.json')
      .then(res => res.json())
      .then(data => L.heatLayer(data, { radius: 25 }).addTo(map));
  
  // load your Excel summary
  fetch('/data/capacity/capacity_summary.xlsx') .then(res=> res.arrayBuffer()) .then(ab=> {
  // Read your sheet once…
  const wb   = XLSX.read(ab, { type: 'array' });
  const ws   = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws);

  // Build a list of “raw” header keys and a human-friendly list
  const weekKeys = Object
    .keys(rows[0])
    .filter(k => k.startsWith('% Used:'))
    // e.g. ["% Used: jan6", "% Used: jan13", …]
  ;
  const weekList = weekKeys.map(k => 
    k.replace('% Used: ', '').trim()
    // e.g. ["jan6","jan13", …]
  );

  // Populate the <select> and set a default
  const selector = document.getElementById('weekSelector');
  weekList.forEach(w => {
    const opt = document.createElement('option');
    opt.value       = w;      // e.g. "mar31"
    opt.textContent = w;      
    selector.append(opt);
  });

  // pick the last week by default:
  let currentWeek = weekList[ weekList.length - 1 ];
  selector.value = currentWeek;

  // Create a layerGroup to hold your markers
  window.npopLayer = L.layerGroup().addTo(map);

  // 5) Factor your draw logic into a function
  function drawNpop(week) {
    // clear out old circles
    window.npopLayer.clearLayers();

    const key = `% Used: ${week}`;
    rows.forEach(r => {
      const pct = Number(r[key]) || 0;
      const lat = parseFloat(r.Lat);
      const lon = parseFloat(r.Lon);
      if (isNaN(lat) || isNaN(lon)) return;

      L.circleMarker([lat, lon], {
        radius: 5.5,
        fillColor: getColor(pct),
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8,
      })
      .bindPopup(`
        <table style="font-size:13px;border-collapse:collapse;width:100%">
          <tr><td><strong>Device Group</strong></td><td>${r.Device_group}</td></tr>
          <tr><td><strong>Location</strong></td><td>${r.Floor}</td></tr>
          <tr><td><strong>Device Name</strong></td><td>${r.Name}</td></tr>
          <tr><td><strong>Postal Code</strong></td><td>${r.Postal_code}</td></tr>
          <tr><td><strong>City</strong></td><td>${r.City}</td></tr>
          <tr><td><strong>Usage</strong></td><td>${pct}%</td></tr>
        </table>
      `)
      .addTo(window.npopLayer);
    });
  }

  // Initial draw
  drawNpop(currentWeek);

  // Re-draw whenever the selector changes
  selector.addEventListener('change', e => {
    currentWeek = e.target.value;
    drawNpop(currentWeek);
  });

  });
      // add a spiderfier to the markers
      oms.addListener('click', function(marker, event) {
        marker.openPopup();
      });

      // add a listener to the week selector
      selector.addEventListener('change', function() {
        currentWeek = this.value;
        drawMap(currentWeek);
        reportBox1.querySelector('span').textContent = usageByPostal[currentWeek]?.count || 0;
        reportBox2.querySelector('span').textContent = usageByPostal[currentWeek]?.deviceCount || 0;
      });

      // draw the map for the first time
      drawMap(currentWeek);
      reportBox1.querySelector('span').textContent = usageByPostal[currentWeek]?.count || 0;
      reportBox2.querySelector('span').textContent = usageByPostal[currentWeek]?.deviceCount || 0;

      // add a filter input
      filterInput.addEventListener('input', function() {
        const term = this.value.toLowerCase();
        const filteredRows = rows.filter(r => r.Name.toLowerCase().includes(term));
        const uniqueNames = [...new Set(filteredRows.map(r => r.Name))];
        filterList.innerHTML = '';
        uniqueNames.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          filterList.appendChild(opt);
        });
      });

      clearBtn.addEventListener('click', function() {
        filterInput.value = '';
        filterList.innerHTML = '';
      });


</script> -->

<script>
  // Initialize map
  const map = L.map('map').setView([43.7, -79.4], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM'}).addTo(map);

  // Gradient color scheme: 0 = special color, then green → yellow-green → yellow → orange → red
  function getColor(d) {
    if (d === 0) return '#b0b8c1'; // No Usage (light gray-blue)
    if (d <= 20) return '#43a047'; // <=20% (green)
    if (d <= 40) return '#cddc39'; // <=40% (yellow-green)
    if (d <= 60) return '#fdd835'; // <=60% (yellow)
    if (d <= 80) return '#fb8c00'; // <=80% (orange)
    if (d >  80) return '#e53935'; // <=100% (red)
    return '#b0b8c1'; // fallback
  }

  // Legend
  // Legend (professional, modern style with unique icons for each label)
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'info legend');
    const grades = [0, 20, 40, 60, 80, 100];
    const labels = [
      {
        text: 'No Usage<br><span style="font-weight:400;color:#888;">0%</span>',
        icon: `<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#b0b8c1" stroke="#fff" stroke-width="1.5"/><text x="10" y="14" text-anchor="middle" font-size="10" fill="#888" font-family="Arial" font-weight="bold">Ø</text></svg>`
      },
      {
        text: 'Very Low<br><span style="font-weight:400;color:#888;">&le;20%</span>',
        icon: `<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#43a047" stroke="#fff" stroke-width="1.5"/><path d="M6 10l3 3 5-5" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`
      },
      {
        text: 'Low<br><span style="font-weight:400;color:#888;">&le;40%</span>',
        icon: `<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#cddc39" stroke="#fff" stroke-width="1.5"/><rect x="7" y="7" width="6" height="6" rx="2" fill="#fffde7" stroke="#bdbd2e" stroke-width="1"/></svg>`
      },
      {
        text: 'Moderate<br><span style="font-weight:400;color:#888;">&le;60%</span>',
        icon: `<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#fdd835" stroke="#fff" stroke-width="1.5"/><path d="M10 5v5l4 2" stroke="#bfa600" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`
      },
      {
        text: 'High<br><span style="font-weight:400;color:#888;">&le;80%</span>',
        icon: `<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#fb8c00" stroke="#fff" stroke-width="1.5"/><polygon points="10,5 13,15 7,15" fill="#fff3e0" stroke="#e65100" stroke-width="1"/></svg>`
      },
      {
        text: 'Critical<br><span style="font-weight:400;color:#888;">&le;100%</span>',
        icon: `<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#e53935" stroke="#fff" stroke-width="1.5"/><path d="M7 7l6 6M13 7l-6 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>`
      }
    ];
    div.innerHTML = `
      <div style="
        font-weight:700;
        font-size:15px;
        margin-bottom:8px;
        color:#23272f;
        letter-spacing:0.1px;
        text-align:left;
      ">
        <span style="display:inline-block;vertical-align:middle;margin-right:6px;">
          <svg width="22" height="22" viewBox="0 0 22 22" style="vertical-align:middle">
            <defs>
              <radialGradient id="legendGlow" cx="50%" cy="50%" r="60%">
                <stop offset="0%" stop-color="#fff176" stop-opacity="0.9"/>
                <stop offset="60%" stop-color="#fb8c00" stop-opacity="0.7"/>
                <stop offset="100%" stop-color="#e53935" stop-opacity="1"/>
              </radialGradient>
            </defs>
            <circle cx="11" cy="11" r="9" fill="url(#legendGlow)" stroke="#23272f" stroke-width="1.5"/>
            <path d="M11 5.5v6" stroke="#23272f" stroke-width="1.5" stroke-linecap="round"/>
            <circle cx="11" cy="15.5" r="1.2" fill="#23272f"/>
          </svg>
        </span>
        Usage Legend
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
    `;
    labels.forEach((obj, i) => {
      div.innerHTML += `
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="display:inline-block;vertical-align:middle;">${obj.icon}</span>
          <span style="font-size:13px;line-height:1.2;">${obj.text}</span>
        </div>
      `;
    });
    div.innerHTML += '</div>';
    return div;
  };
  legend.addTo(map);

  // Data containers
  let rows = [];
  window.npopLayer = L.layerGroup().addTo(map);

  // Load Excel & prepare weeks
  fetch('data/capacity/capacity_summary.xlsx').then(r=>r.arrayBuffer()).then(ab=>{
    const wb = XLSX.read(ab,{type:'array'});
    rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    const weekKeys = Object.keys(rows[0]).filter(k=>k.startsWith('% Used:'));
    const weeks = weekKeys.map(k=>k.replace('% Used: ','').trim());
    const sel = document.getElementById('weekSelector');
    weeks.forEach(w=>{const o=document.createElement('option'); o.value = o.textContent = w; sel.append(o);});
    sel.value = weeks[weeks.length-1];
    drawNpop(sel.value);
    sel.addEventListener('change', ()=> drawNpop(sel.value));
  });

  // Draw NPOP markers for a given week
  function drawNpop(week){
    window.npopLayer.clearLayers();
    const key = `% Used: ${week}`;
    rows.forEach(r=>{
      const pct = Number(r[key]) || 0;
      const lat = parseFloat(r.Lat), lon = parseFloat(r.Lon);
      if(isNaN(lat)||isNaN(lon)) return;

      // Choose SVG icon based on usage
      let svgIcon;
      if (pct === 0) {
        svgIcon = `<svg width="28" height="28" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#b0b8c1" stroke="#fff" stroke-width="2"/><text x="10" y="14" text-anchor="middle" font-size="10" fill="#888" font-family="Arial" font-weight="bold">Ø</text></svg>`;
      } else if (pct <= 20) {
        svgIcon = `<svg width="28" height="28" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#43a047" stroke="#fff" stroke-width="2"/><path d="M6 10l3 3 5-5" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`;
      } else if (pct <= 40) {
        svgIcon = `<svg width="28" height="28" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#cddc39" stroke="#fff" stroke-width="2"/><rect x="7" y="7" width="6" height="6" rx="2" fill="#fffde7" stroke="#bdbd2e" stroke-width="1"/></svg>`;
      } else if (pct <= 60) {
        svgIcon = `<svg width="28" height="28" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#fdd835" stroke="#fff" stroke-width="2"/><path d="M10 5v5l4 2" stroke="#bfa600" stroke-width="2" fill="none" stroke-linecap="round"/></svg>`;
      } else if (pct <= 80) {
        svgIcon = `<svg width="28" height="28" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#fb8c00" stroke="#fff" stroke-width="2"/><polygon points="10,5 13,15 7,15" fill="#fff3e0" stroke="#e65100" stroke-width="1"/></svg>`;
      } else {
        svgIcon = `<svg width="28" height="28" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#e53935" stroke="#fff" stroke-width="2"/><path d="M7 7l6 6M13 7l-6 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>`;
      }

      const m = L.marker([lat, lon], {
        icon: L.divIcon({
          className: 'custom-legend-icon',
          html: svgIcon,
          iconSize: [28, 28],
          iconAnchor: [14, 14],
          popupAnchor: [0, -12]
        })
      });
     m.on('click', function(e) { m.openPopup(); }); m.on('mouseover', function(e) { m.setStyle({ radius: 8, weight: 2, color: '#222' }); m.bringToFront();}); m.on('mouseout', function(e) { m.setStyle({ radius: 5.5, weight: 1, color: '#333' }); });

      m.options.props = r;
      m.bindPopup(
        `
        <div style="font-family:'Segoe UI',Arial,sans-serif;max-width:100%;margin:0;padding:0;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
            <span style="
              display:inline-block;
              width:100%;
              box-sizing:border-box;
              padding:5px 0 5px 12px;
              border-radius:6px 6px 0 0;
              background: linear-gradient(90deg, #e9ecef 0%, #f8fafc 100%);
              box-shadow: none;
              font-size:16px;
              font-weight:700;
              color:#23272f;
              letter-spacing:0.2px;
              border: none;
              text-shadow:none;
              margin:0;
              transition:background 0.3s;
            ">
              ${r.Name || 'Device'}
              <span style="
          font-size:13px;
          font-weight:700;
          margin-left:10px;
            color:#222;
            background:${getColor(pct)}CC;
            ${pct >= 20 ? 'box-shadow:0 0 0 3px #ff9800aa;' : ''}
          border-radius:5px;
          padding:3px 2px;
          border:1.5px solid #fff;
          box-shadow:0 1px 4px rgba(0,0,0,0.10);
          text-shadow:0 1px 2px #fff;
          letter-spacing:0px;
              ">
          ${pct}%
              </span>
            </span>
          </div>
        </div>
          <div style="margin-bottom:6px;">
        <span style="color:#555;">${r.Address || ''}</span>
          </div>
          <table style="width:100%;border-collapse:collapse;font-size:13px;background:#f9fbfd;border-radius:6px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.06);">
        <tr>
          <td style="padding:4px 8px;color:#888;">Entity ID</td>
          <td style="padding:4px 8px;font-weight:500;">${r.Device_Entity_ID}</td>
        </tr>
        <tr style="background:#f1f6fa;">
          <td style="padding:4px 8px;color:#888;">Device Group</td>
          <td style="padding:4px 8px;">${r.Device_group}</td>
        </tr>
        <tr>
          <td style="padding:4px 8px;color:#888;">Location</td>
          <td style="padding:4px 8px;">${r.Floor}</td>
        </tr>
        <tr style="background:#f1f6fa;">
          <td style="padding:4px 8px;color:#888;">Postal Code</td>
          <td style="padding:4px 8px;">${r.Postal_code}</td>
        </tr>
        <tr>
          <td style="padding:4px 8px;color:#888;">City</td>
          <td style="padding:4px 8px;">${r.City}</td>
        </tr>
        <tr style="background:#f1f6fa;">
          <td style="padding:4px 8px;color:#888;">Usage</td>
          <td style="padding:4px 8px;font-weight:bold;color:${getColor(pct)}">${pct}%</td>
        </tr>
          </table>
        </div>
        `
      );
      m.on('click', e => {
        const popup = e.target.getPopup();
        if (popup) {
          popup.setLatLng(e.latlng);
          popup.openOn(map);
        }
      });
      m.on('mouseover', e => {
        m.setStyle({ radius: 8, weight: 3, color: '#000', fillOpacity: 1 });;
      });
      m.on('mouseout', function(e) {
        m.setStyle({ radius: 5.5, weight: 1, color: '#333' });
      });
      window.npopLayer.addLayer(m);
    });
  }

  // SEARCH LOGIC
  const searchInput = document.getElementById('searchInput');
  const suggestions = document.getElementById('suggestions');
  const modeRadios = document.querySelectorAll('input[name="searchMode"]');

  // Prepare suggestion lists
  const searchData = {
    Device_Entity_ID: [...new Set(rows.map(r => r.Device_Entity_ID).filter(Boolean))].sort(),
    Address:           [...new Set(rows.map(r => r.Address).filter(Boolean))].sort()
  };

  // Update datalist options
  function updateSuggestions(term=''){
    const mode = document.querySelector('input[name="searchMode"]:checked').value;
    suggestions.innerHTML = '';
    searchData[mode]
      .filter(v => v.toLowerCase().includes(term.toLowerCase()))
      .slice(0,10)
      .forEach(v => { const opt = document.createElement('option'); opt.value = v; suggestions.append(opt); });
  }
  searchInput.addEventListener('input', e => updateSuggestions(e.target.value));
  modeRadios.forEach(radio => radio.addEventListener('change', ()=>{
    searchInput.value = '';
    updateSuggestions();
    searchInput.focus();
  }));

  // Perform search on change or Enter
  function performSearch(){
    const mode = document.querySelector('input[name="searchMode"]:checked').value;
    const query = searchInput.value.trim().toLowerCase(); if(!query) return;
    let found=false;
    window.npopLayer.eachLayer(marker => {
      const val = (marker.options.props[mode] || '').toString().toLowerCase();
      if(val === query){
        map.setView(marker.getLatLng(), 14);
        marker.openPopup();
        found=true;
      }
    });
    if(!found) alert(`No match for "${searchInput.value}" in ${mode}`);
  }
  searchInput.addEventListener('change', performSearch);
  searchInput.addEventListener('keydown', e => { if(e.key==='Enter'){ performSearch(); e.preventDefault(); }});
</script>


</body></html>